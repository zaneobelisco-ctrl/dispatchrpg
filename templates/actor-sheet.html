<form class="dispatch-sheet duke-collins">
  <header class="sheet-header">
    <div class="left">
      <div class="portrait">
        <img src="{{#if actor.img}}{{actor.img}}{{else}}icons/svg/mystery-man.svg{{/if}}" alt="avatar" id="pc-portrait"/>
        <div class="portrait-controls">
          <button type="button" class="btn" id="btn-upload-photo">Upload Foto</button>
        </div>
      </div>
    </div>

    <div class="center">
      <input class="char-name" name="name" type="text" value="{{actor.name}}" placeholder="Nome do Personagem" />
      <div class="meta-row">
        <div class="meta-field"><label>Ra√ßa</label><input class="meta small" name="data.raca" placeholder="Ra√ßa" value="{{data.raca}}" /></div>
        <div class="meta-field"><label>Classe Social</label><input class="meta small" name="data.classeSocial" placeholder="Classe Social" value="{{data.classeSocial}}" /></div>
        <div class="meta-field"><label>Idade</label><input class="meta tiny" name="data.idade" placeholder="Idade" value="{{data.idade}}" /></div>
        <div class="meta-field"><label>Altura</label><input class="meta tiny" name="data.altura" placeholder="Altura" value="{{data.altura}}" /></div>
        <div class="meta-field"><label>Peso</label><input class="meta tiny" name="data.peso" placeholder="Peso" value="{{data.peso}}" /></div>
      </div>
    </div>

    <div class="right">
      <div class="status-block">
        <label>PV</label>
        <input name="data.pv" value="{{data.pv}}" />
      </div>
      <div class="status-block">
        <label>PP</label>
        <input name="data.pp" value="{{data.pp}}" />
      </div>
      <div class="status-block">
        <label>SAN</label>
        <input name="data.san" value="{{data.san}}" />
      </div>
    </div>
  </header>

  <nav class="tabs">
    <button type="button" class="tab active" data-tab="atributos">Atributos</button>
    <button type="button" class="tab" data-tab="pericias">Per√≠cias</button>
    <button type="button" class="tab" data-tab="status">Status</button>
    <button type="button" class="tab" data-tab="poderes">Poderes</button>
    <button type="button" class="tab" data-tab="biografia">Biografia</button>
  </nav>

  <section class="tabcontent" data-tabcontent="atributos">
    <div class="attributes-grid">
      {{#each data.atributos}}
      <div class="attr">
        <label>{{@key}}</label>
        <input type="number" name="data.atributos.{{@key}}" value="{{this}}" />
      </div>
      {{/each}}
    </div>
  </section>

  <section class="tabcontent" data-tabcontent="pericias" style="display:none">
    <div class="pericias-grid">
      {{#if data.pericias}}
        {{#each data.pericias}}
        <div class="skill-row">
          <div class="skill-label">{{@key}}</div>
          <input class="skill-input" type="number" name="data.pericias.{{@key}}" value="{{this}}" />
          <button type="button" class="roll btn-small" data-skill="{{@key}}">üé≤</button>
        </div>
        {{/each}}
      {{else}}
        <div>Nenhuma per√≠cia definida.</div>
      {{/if}}
      <p class="hint">Duplo clique no n√∫mero da per√≠cia: +1. Shift + duplo clique: -1.</p>
    </div>
  </section>

  <section class="tabcontent" data-tabcontent="status" style="display:none">
    <div class="status-grid">
      <div class="status-item"><label>Iniciativa</label><input name="data.iniciativa" value="{{data.iniciativa}}" /></div>
      <div class="status-item"><label>Movimento (m/turno)</label><input name="data.movimento" value="{{data.movimento}}" /></div>
      <div class="status-item"><label>Taxa de Cura</label><input name="data.taxaCura" value="{{data.taxaCura}}" /></div>
    </div>
  </section>

  <section class="tabcontent" data-tabcontent="poderes" style="display:none">
    <div class="powers-list">
      <label>Poderes e T√©cnicas</label>
      <textarea name="data.poderes" placeholder="Descreva suas t√©cnicas...">{{data.poderes}}</textarea>
    </div>
  </section>

  <section class="tabcontent" data-tabcontent="biografia" style="display:none">
    <label>Biografia</label>
    <textarea name="data.biografia" placeholder="Hist√≥ria, background...">{{data.biografia}}</textarea>
  </section>

  <footer class="sheet-footer">
    <div class="footer-left">Dispatch RPG ‚Äî Ficha</div>
  </footer>
</form>

<script>
document.addEventListener('click', (ev) => {
  const t = ev.target;
  if (t.classList && t.classList.contains('tab')) {
    const app = t.closest('.app') || document;
    app.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));
    t.classList.add('active');
    const name = t.dataset.tab;
    app.querySelectorAll('.tabcontent').forEach(x=>x.style.display='none');
    const target = app.querySelector(`[data-tabcontent="${name}"]`);
    if (target) target.style.display='block';
  }

  if (t.id === 'btn-upload-photo') {
    const fp = new FilePicker({
      type: "image",
      callback: (path) => {
        const app = t.closest(".app");
        const actorId = app?.dataset?.actorId || app?.getAttribute('data-actor-id');
        if (actorId) {
          const actor = game.actors.get(actorId);
          actor.update({img: path});
        } else {
          ui.notifications.warn("Salve a ficha primeiro para definir a foto.");
        }
      }
    });
    fp.render(true);
  }
});
</script>
