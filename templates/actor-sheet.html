<form class="dispatch-sheet duke-collins">
  <header class="sheet-header">
    <div class="left">
      <div class="portrait">
        <!-- Handlebars-safe image selection -->
        <img src="{{#if actor.img}}{{actor.img}}{{else}}icons/svg/mystery-man.svg{{/if}}" alt="avatar" id="pc-portrait"/>
        <div class="portrait-controls">
          <button type="button" class="btn" id="btn-upload-photo">Upload Foto</button>
        </div>
      </div>
    </div>

    <div class="center">
      <input class="char-name" name="name" type="text" value="{{actor.name}}" placeholder="Nome do Personagem" />
      <div class="meta-row">
        <input class="meta small" name="data.raca" placeholder="RaÃ§a" value="{{data.raca}}" />
        <input class="meta small" name="data.classeSocial" placeholder="Classe Social" value="{{data.classeSocial}}" />
        <input class="meta tiny" name="data.idade" placeholder="Idade" value="{{data.idade}}" />
        <input class="meta tiny" name="data.altura" placeholder="Altura" value="{{data.altura}}" />
        <input class="meta tiny" name="data.peso" placeholder="Peso" value="{{data.peso}}" />
      </div>
    </div>

    <div class="right">
      <div class="status-block">
        <label>PV</label>
        <input name="data.pv" value="{{data.pv}}" />
      </div>
      <div class="status-block">
        <label>PP</label>
        <input name="data.pp" value="{{data.pp}}" />
      </div>
      <div class="status-block">
        <label>SAN</label>
        <input name="data.san" value="{{data.san}}" />
      </div>
    </div>
  </header>

  <nav class="tabs">
    <button type="button" class="tab active" data-tab="atributos">Atributos</button>
    <button type="button" class="tab" data-tab="pericias">PerÃ­cias</button>
    <button type="button" class="tab" data-tab="status">Status</button>
    <button type="button" class="tab" data-tab="poderes">Poderes</button>
    <button type="button" class="tab" data-tab="biografia">Biografia</button>
  </nav>

  <section class="tabcontent" data-tabcontent="atributos">
    <div class="attributes-grid">
      {{#each data.atributos}}
      <div class="attr">
        <label>{{@key}}</label>
        <input type="number" name="data.atributos.{{@key}}" value="{{this}}" />
      </div>
      {{/each}}
    </div>
  </section>

  <section class="tabcontent" data-tabcontent="pericias" style="display:none">
    <div class="pericias-grid">
      {{#if data.pericias}}
        {{#each data.pericias}}
        <div class="skill-row">
          <label>{{@key}}</label>
          <input type="number" name="data.pericias.{{@key}}" value="{{this}}" />
          <button type="button" class="roll btn-small" data-skill="{{@key}}">ðŸŽ²</button>
        </div>
        {{/each}}
      {{else}}
        <div>Nenhuma perÃ­cia definida.</div>
      {{/if}}
    </div>
  </section>

  <section class="tabcontent" data-tabcontent="status" style="display:none">
    <div class="status-grid">
      <div class="status-item"><label>Iniciativa</label><input name="data.iniciativa" value="{{data.iniciativa}}" /></div>
      <div class="status-item"><label>Movimento (m/turno)</label><input name="data.movimento" value="{{data.movimento}}" /></div>
      <div class="status-item"><label>Taxa de Cura</label><input name="data.taxaCura" value="{{data.taxaCura}}" /></div>
    </div>
  </section>

  <section class="tabcontent" data-tabcontent="poderes" style="display:none">
    <div class="powers-list">
      <label>Poderes e TÃ©cnicas</label>
      <textarea name="data.poderes" placeholder="Descreva suas tÃ©cnicas...">{{data.poderes}}</textarea>
    </div>
  </section>

  <section class="tabcontent" data-tabcontent="biografia" style="display:none">
    <label>Biografia</label>
    <textarea name="data.biografia" placeholder="HistÃ³ria, background...">{{data.biografia}}</textarea>
  </section>

  <footer class="sheet-footer">
    <div class="footer-left">Dispatch RPG â€” Ficha</div>
  </footer>
</form>

<script>
/* Tab switching (runs in sheet context) */
document.addEventListener('click', (ev) => {
  const t = ev.target;
  if (t.classList && t.classList.contains('tab')) {
    const app = t.closest('.app') || document;
    app.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));
    t.classList.add('active');
    const name = t.dataset.tab;
    app.querySelectorAll('.tabcontent').forEach(x=>x.style.display='none');
    const target = app.querySelector(`[data-tabcontent="${name}"]`);
    if (target) target.style.display='block';
  }

  /* Upload portrait using Foundry FilePicker */
  if (t.id === 'btn-upload-photo') {
    const fp = new FilePicker({
      type: "image",
      callback: (path) => {
        const app = t.closest(".app");
        const actorId = app?.dataset?.actorId || app?.getAttribute('data-actor-id');
        if (actorId) {
          const actor = game.actors.get(actorId);
          actor.update({img: path});
        } else {
          ui.notifications.warn("Salve a ficha primeiro para definir a foto.");
        }
      }
    });
    fp.render(true);
  }

  /* Roll handler here just invokes sheet's click handlers â€” actual roll should be in actor-sheet class */
  if (t.classList && t.classList.contains('roll')) {
    // trigger a click on the sheet instance (the sheet class handles roll)
    // no-op here: sheet class already registered roll handlers on .roll elements
  }
});
</script>
